- [1 整理工作步骤](https://cf.jd.com/pages/viewpage.action?pageId=409166321#EasyOLAP大促宝典-1整理工作步骤)
  - [1.1 概要](https://cf.jd.com/pages/viewpage.action?pageId=409166321#EasyOLAP大促宝典-1.1概要)
  - [1.2 备战工作项目安排](https://cf.jd.com/pages/viewpage.action?pageId=409166321#EasyOLAP大促宝典-1.2备战工作项目安排)
- [2 准备工作-大促前 未完善功能准备](https://cf.jd.com/pages/viewpage.action?pageId=409166321#EasyOLAP大促宝典-2准备工作-大促前未完善功能准备)
  - [2.1 集群规划和迁移（重要） 李海波](https://cf.jd.com/pages/viewpage.action?pageId=409166321#EasyOLAP大促宝典-2.1集群规划和迁移（重要）)
  - [2.2 、系统/CK/ZK版本和配置升级（一般） 周辉 阳仔](https://cf.jd.com/pages/viewpage.action?pageId=409166321#EasyOLAP大促宝典-2.2、系统/CK/ZK版本和配置升级（一般）阳仔)
  - [2.3、目录、日志和Core规范（重要CK） 王高明 宋恩杰](https://cf.jd.com/pages/viewpage.action?pageId=409166321#EasyOLAP大促宝典-2.3、目录、日志和Core规范（重要CK）)
  - [2.4、资源和配额限制（重要） 吴建超 李阳](https://cf.jd.com/pages/viewpage.action?pageId=409166321#EasyOLAP大促宝典-2.4、资源和配额限制（重要）)
  - [2.5、主备双流和业务降级 何孟滕10月13号结束](https://cf.jd.com/pages/viewpage.action?pageId=409166321#EasyOLAP大促宝典-2.5、主备双流和业务降级10月13号结束)
- [3 集群巡检 检查](https://cf.jd.com/pages/viewpage.action?pageId=409166321#EasyOLAP大促宝典-3集群巡检检查)
- [4 备战值班, 压测、集群负责人下发](https://cf.jd.com/pages/viewpage.action?pageId=409166321#EasyOLAP大促宝典-4备战值班,压测、集群负责人下发)
  - [4.1 开发人员负责下下发](https://cf.jd.com/pages/viewpage.action?pageId=409166321#EasyOLAP大促宝典-4.1开发人员负责下下发)
  - [4.2 双11前常规值班表（10.13~10.31）](https://cf.jd.com/pages/viewpage.action?pageId=409166321#EasyOLAP大促宝典-4.2双11前常规值班表（10.13~10.31）)
  - [4.3 人员联系方式](https://cf.jd.com/pages/viewpage.action?pageId=409166321#EasyOLAP大促宝典-4.3人员联系方式)
- [5. 压测](https://cf.jd.com/pages/viewpage.action?pageId=409166321#EasyOLAP大促宝典-5.压测)
  - [压测流程 ](https://cf.jd.com/pages/viewpage.action?pageId=409166321#EasyOLAP大促宝典-压测流程)
  - [独占集群压测记录](https://cf.jd.com/pages/viewpage.action?pageId=409166321#EasyOLAP大促宝典-独占集群压测记录)
  - [共享集群压测记录](https://cf.jd.com/pages/viewpage.action?pageId=409166321#EasyOLAP大促宝典-共享集群压测记录)
  - [OLAP（10个）](https://cf.jd.com/pages/viewpage.action?pageId=409166321#EasyOLAP大促宝典-OLAP（10个）)
- [注意事项：](https://cf.jd.com/pages/viewpage.action?pageId=409166321#EasyOLAP大促宝典-注意事项：)
- [后续优化方向：](https://cf.jd.com/pages/viewpage.action?pageId=409166321#EasyOLAP大促宝典-后续优化方向：)







注：以下所有操作 都需至少两人互为BACKUP执行和Check，公开

# 1 整理工作步骤

## 1.1 概要



第1步：保障目标确认： 明确所有保障业务，所有集群业务级别[https://joyspace.jd.com/sheet/XYoaleIspuac8JneQO3Q](http://xn--vhq33i241cjxk/)、[集群规划](https://cf.jd.com/pages/viewpage.action?pageId=318380507)非0级业务大促期间不允许对集群有任何操作，后续总结步骤集群都为0级业务集群 ( eg: 集群、部门、业务、场景、系统级别、数据属性（实时/离线），预测峰值，用户账号等)

第2步：集群封版确认：明确集群版本信息，[CK集群升级情况](https://cf.jd.com/pages/viewpage.action?pageId=370157021)  [clickhouse 元数据一致性检测](https://cf.jd.com/pages/viewpage.action?pageId=366300921) [ZK升级流程](https://cf.jd.com/pages/viewpage.action?pageId=373982877)(eg: clickhouse版本、用户jdbc版本确认、zookeeper 版本、集群配置的版本)

第3步：集群灾备、双流确认：集群需有备份机器、双流(双机房)方案，[集群压测和双流登记表](https://cf.jd.com/pages/viewpage.action?pageId=360385731) (集群配置统计、可备份集群统计、业务双流机房统计)

第4步：集群数据量突增控制确认：所有业务库表信息，[集群压测和双流登记表](https://cf.jd.com/pages/viewpage.action?pageId=360385731) 。控制业务建库建表权限，预防新增业务影响集群 (业务库表统计、数据量统计、限制用户建库建表，避免新增业务接入olap人员不知的情况)

第5步：开发人员明确保障任务：部门负责人合理安排值班表，[2020双十一备战](https://cf.jd.com/pages/viewpage.action?pageId=358219800)。

第6步：集群配额控制： 集群负载控制、从集群资源、服务请求、查询、写入等方便合理配置集群配合，[Clickhouse和Zookeeper参数设置](https://cf.jd.com/pages/viewpage.action?pageId=363171303)，[clickhouse quota](https://cf.jd.com/display/kubernetes/clickhouse+quota) 保障集群稳定运行 根据业务数据量、集群查询压力等

第7步：全保真压测：尽最大可能模拟大促场景，集群[故障演练](https://cf.jd.com/pages/viewpage.action?pageId=374490730)、节点替换、主备切换，业务压测，[CK to CK数据迁移](https://cf.jd.com/pages/viewpage.action?pageId=364756447)等，记录在册，最终达到压测目标

第8步：集群压测完成确认：未达到效果，重复执行6，7操作（多次执行未果，需考虑扩容、切换集群。如因服务版本问题，需从第2步重新开始），达到效果，进入第9步

第9步：大促操作流程确认：开发人员和所负责业务人员梳理大促间操作流程，[OLAP双十一值班检查表](https://cf.jd.com/pages/viewpage.action?pageId=379917723)。(如非0级业务降级时间、数据写入时间、数据停止写入时间、

第10步：部门负责人确认：部门负责人确认以上流程完整正确执行。





## 1.2 备战工作项目安排



| 序号 |          备战工作项          |    开始时间    |                        结束时间                         |                             状态                             |        负责人        |      |
| :--: | :--------------------------: | :------------: | :-----------------------------------------------------: | :----------------------------------------------------------: | :------------------: | :--- |
|  1   |        集群规划和迁移        |   2020/9/21    |                       2020/10/25                        |   物流30台机器到位，Doris集群已经提供了，物流正在迁移数据    | 李海波、李阳、卢泽萍 |      |
|  2   |   系统/CK/ZK版本和配置升级   |   2020/9/21    |                       2020/10/25                        |             done，集群配置升级成功，商智的不升级             |    周辉、李阳830     |      |
|  3   |    CK目录、日志和Core规范    |   2020/10/9    |                       2020/10/25                        |                             done                             |    王高明、宋恩杰    | ✅    |
|  4   |      资源和配额限制方案      |   2020/10/9    |                       2020/10/25                        |   done，quota工具已上线，共享集群quota以设置，阈值调整完毕   |        吴建超        |      |
|  5   |    主备双流和业务降级方案    |   2020/9/21    |                       2020/10/31                        |                            doing                             |        何孟滕        |      |
|  6   |        监控和报警配置        |   2020/9/21    |                       2020/10/23                        |                             done                             |        吴建超        |      |
|  7   |  故障运维、压测演练工具开发  |   2020/9/14    |                       2020/10/23                        | done黄金眼、商智压测达标，共享集群压测达标下线、替换、冒烟完成一致性工具本周完成 |    王高明、宋恩杰    | 完成 |
|  8   | 元数据、数据一致性报警和工具 |   2020/10/9    |                       2020/10/23                        |                         吴建超、阳仔                         |                      |      |
|  9   |         配合业务压测         | 2020/10/25左右 |                          done                           |                           OLAP团队                           |                      |      |
|  10  |           故障演练           | 2020/10/21左右 | 测试集群进行了8轮演练：节点挂、磁盘挂、机器挂、节点替换 |                            李海波                            |                      |      |
|  11  |           降级演练           | 2020/10/21左右 |                          done                           |                            李海波                            |                      |      |
|  12  |           集群巡检           |   2020/10/19   |                       2020/10/31                        |                            doing                             |       OLAP团队       |      |







# 2 准备工作-大促前 未完善功能准备

## 2.1 集群规划和迁移（重要） [李海波](https://cf.jd.com/display/~lihaibo42)

- jd_olap_04 10月15号前下线，13服务器（8台补充到HT0_DR_Pub_01），留5台备用 [李阳](https://cf.jd.com/display/~liyang453) [卢泽萍](https://cf.jd.com/display/~luzeping) done**
  **
- HT1_DR_TS_01下线，机器搬迁到KC0，补充到KC0_DR_Pub_02中 [李阳](https://cf.jd.com/display/~liyang453) done
- Doris测试集群申请新的服务器 [李海波](https://cf.jd.com/display/~lihaibo42) done
- Kylin的除了黄金眼其他业务尽量迁移到DR/CK 10月底 [李阳](https://cf.jd.com/display/~liyang453) ing
- 协调服务器：推荐实时33台服务器，搜索平台21台服务器 [李海波](https://cf.jd.com/display/~lihaibo42) done

## 2.2 、系统/CK/ZK版本和配置升级（一般） [周辉](https://cf.jd.com/display/~zhouhui145) 阳仔

[Clickhouse和Zookeeper参数设置](https://cf.jd.com/pages/viewpage.action?pageId=363171303)

- CK版本升级到20.6.6.7（逐步升级） [周辉](https://cf.jd.com/display/~zhouhui145)
- ZK日志和数据目录分离
- ZK的配置优化和JVM参数优化（逐步升级）
- 京东云的ZK询问一下参数

## 2.3、目录、日志和Core规范（重要CK） [王高明](https://cf.jd.com/display/~wanggaoming1) [宋恩杰](https://cf.jd.com/display/~songenjie)

- SSH免密登陆 @阳仔 （已完成）
- 不同进程日志分磁盘存储/data0/data4/data8...
- 保留TRACE级别以上日志，保留20份，日志大小切割为1024M
- 打开Core Limit，保留最近5份Core文件，Core大小<100G以内 100G限制
- 进程重启需要能看到重启时间

## 2.4、资源和配额限制（重要） [吴建超](https://cf.jd.com/display/~wujianchao5) [李阳](https://cf.jd.com/display/~liyang453)

- ck
  - 内存限制：read_rows
  - 请求限制：queries
- 进度
  - 方案，done
  - quota工具，done
  - quota阈值评估，done
  - quota阈值调整，进行中
  - 文档地址：[CK Quota机制](https://cf.jd.com/pages/viewpage.action?pageId=365846045)
- [doris资源限制](https://cf.jd.com/pages/viewpage.action?pageId=365359099#doris灾备、限流、降级、熔断演练-限流)

## 2.5、主备双流和业务降级 [何孟滕](https://cf.jd.com/display/~hemengteng)10月13号结束

[集群压测和双流登记表](https://cf.jd.com/pages/viewpage.action?pageId=360385731)

![img](https://cf.jd.com/download/attachments/409166321/image2020-12-23_17-19-58.png?version=1&modificationDate=1608715200000&api=v2)



# 3 集群巡检 检查

| 巡检内容                                                     | 第一轮负责人 | 第一轮巡检进度 | 第二轮负责人 | 第二轮巡检进度 | 备注 |
| :----------------------------------------------------------- | :----------- | :------------- | :----------- | :------------- | :--- |
| BE、FE、BROKER日志滚动切分是否有效（/data0/jdolap/fe_deploy/conf） | 邬行泽       | **100%**       | 卢泽萍       | **0%**         |      |
| BE、FE、BROKER日志目录是否正确（ipCheck.sh获得集群列表） https://git.jd.com/bag/jdolap-deploy/tree/master/cluster-conf | 邬行泽       | **100%**       | 卢泽萍       | **0%**         |      |
| BE、FE、BROKER部署目录是否正确（ipCheck.sh获得集群列表） https://git.jd.com/bag/jdolap-deploy/tree/master/cluster-conf | 邬行泽       | **100%**       | 卢泽萍       | **0%**         |      |
| BE、FE、BROKER配置是否与git一致并且正确 https://git.jd.com/bag/jdolap-deploy/tree/master/cluster-conf | 邬行泽       | **100%**       | 卢泽萍       | **0%**         |      |
| core文件配置是否正确（打开、大小、目录）(只操作 测试集群)(暂时不看) | 邬行泽       | **100%**       | 卢泽萍       | **0%**         |      |
| HT0_DR_Pub_01与KC0_DR_Pub_02 routine load一致性检查          | 邬行泽       | **100%**       | 卢泽萍       | **0%**         |      |
| HT0_DR_Pub_01与KC0_DR_Pub_02库一致性检查                     | 邬行泽       | **100%**       | 卢泽萍       | **0%**         |      |
| HT0_DR_Pub_01与KC0_DR_Pub_02表一致性检查                     | 邬行泽       | **100%**       | 卢泽萍       | **0%**         |      |
| HT0_DR_Pub_01与KC0_DR_Pub_02表数据量差异过大的检查           | 邬行泽       | **100%**       | 卢泽萍       | **0%**         |      |
| service配置是否正确                                          | 邬行泽       | **100%**       | 卢泽萍       | **0%**         |      |
| 是否存在分区过多的表检查（adPartCheck.sh）                   | 邬行泽       | **100%**       | 卢泽萍       | **0%**         |      |
| 是否存在分桶过多的表检查(bucketCheck.sh)                     | 邬行泽       | **100%**       | 卢泽萍       | **0%**         |      |
| 是否存在分桶过少的表检查(bucketCheck.sh)                     | 邬行泽       | **100%**       | 卢泽萍       | **0%**         |      |
| 是否存在副本不为3的表检查（replicaCheck.sh)                  | 邬行泽       | **100%**       | 卢泽萍       | **0%**         |      |
| 是否存在单分区的表检查（adPartCheck.sh）                     | 邬行泽       | **100%**       | 卢泽萍       | **0%**         |      |
| 检查所有库的存储quota是否有超过80%（quotaCheck.sh）          | 邬行泽       | **100%**       | 卢泽萍       | **0%**         |      |
| 检查是否有不健康的tablet（unhealthyTablet.sh）               | 邬行泽       | **100%**       | 卢泽萍       | **0%**         |      |



# 4 备战值班, 压测、集群负责人下发

## 4.1 开发人员负责下下发

- 值班：

  备战值班表

  - 监控
  - 报警
  - 客户支持

- 集群

  - 重点：独占0级、共享0级

- 责任人

  - CK：海波、建超、周辉、高明、恩杰、阳仔
    - 独占0级集群 海波、恩杰：
      - 黄金眼：Pub01、Pub02（未上线）
      - 商智：Pub04、Pub08、Pub18（未上线）
      - 生态业务-供应链：Pub07（未上线）
    - 独占共享平台部 建超、周辉：
      - Pub061、Pub062、Pub063
    - 数据基础平台 建超、周辉
      - 售后全链路（0级）：Pub17
      - EasyData：Pub19
    - 共享集群 高明、阳仔：
      - 共享Pub10（离线）：
      - 共享Pub11（离线）：
      - 共享Pub12（实时）：
  - Doris：李阳、行泽、泽萍
    - 主、备、商提：李阳
    - 动力：行泽
    - 物流：行泽
    - 搜推：泽萍

## **4.2 双11前常规值班表（10.13~10.31）**

|              | 10.13  | 10.14  | 10.15  | 10.16  | 10.17  | 10.18  | 10.19  | 10.20  | 10.21  | 10.22  | 10.23 | 10.24 | 10.25 | 10.26 | 10.27 | 10.28  | 10.29  | 10.30  | 10.31  |
| :----------- | :----- | :----- | :----- | :----- | :----- | :----- | :----- | :----- | :----- | :----- | :---- | :---- | :---- | :---- | :---- | :----- | :----- | :----- | :----- |
|              | 周二   | 周三   | 周四   | 周五   | 周六   | 周日   | 周一   | 周二   | 周三   | 周四   | 周五  | 周六  | 周日  | 周一  | 周二  | 周三   | 周四   | 周五   | 周六   |
| 值班人员1    | 周辉   | 周辉   | 周辉   | 周辉   | 周辉   | 吴建超 | 吴建超 | 吴建超 | 吴建超 | 吴建超 | 李阳  | 李阳  | 李阳  | 李阳  | 李阳  | 李海波 | 李海波 | 李海波 | 李海波 |
| 值班人员2    | 王高明 | 王高明 | 王高明 | 王高明 | 王高明 | 宋恩杰 | 宋恩杰 | 宋恩杰 | 宋恩杰 | 宋恩杰 | 阳仔  | 阳仔  | 阳仔  | 阳仔  | 阳仔  | 邬行泽 | 邬行泽 | 邬行泽 | 邬行泽 |
| 备份值班人员 | 李琳   |        |        |        |        |        |        |        |        |        |       |       |       |       |       |        |        |        |        |



**
【注意】：双11期间（11.01-11.12）全员值班**

## 4.3 人员联系方式

李海波（lihaibo42）：18610096286/18001290189
李阳（liyang453）：18612259906/13716415627
王高明（wanggaoming1）：15313098001
周辉（zhouhui155）：18701698209
吴建超（wujianchao5）：18513100323
邬行泽（wuhangze）：13126930042
李琳（sre）（lilin466）：15574923496
宋恩杰（songenjie）（songenjie）：15313504109
阳仔（liyang830）（liyang830）：17600605812

# 5. 压测

[doris灾备、限流、降级、熔断演练](https://cf.jd.com/pages/viewpage.action?pageId=365359099)



## 压测流程 



1. 流量初步预估：双十一是今年618流量的1.5倍，是日常的3倍
2. 0级已上线，如要双流，请提前提出
3. 独占集群，请各业务侧自己组织压测，压测后记录在如下表格中
4. 共享集群集中在10月19这一周压测，具体时间待定
5. 未上线的业务，请在“是否已上线”中登记为“否”
6. 未压测的业务，也烦请登记，在“是否已压测”中登记“否”



注：非0级业务请勿擅自填写，否则将会非法占用中台保障资源！！！



0级业务定义参考：[零售子集团线上事故定级、定责及扣分标准](https://cf.jd.com/pages/viewpage.action?pageId=263771899)



## 独占集群压测记录



| OLAP 服务 |      集群      |           业务           |                         部门和接口人                         | 业务级别0/非0 | 是否已上线是否可降级是/否 |         是否已压测是/否压测时间          |               压测峰值写入：xx Byte/s查询：QPS               | 压测资源情况CPU/内存/磁盘                    | 是否需双流是/否 |    双流方案有/无    | 切换演练   |              需要OLAP团队协助              |
| :-------: | :------------: | :----------------------: | :----------------------------------------------------------: | :-----------: | :-----------------------: | :--------------------------------------: | :----------------------------------------------------------: | :------------------------------------------- | :-------------: | :-----------------: | :--------- | :----------------------------------------: |
| Doris独占 | KC0_DR_Pub_03  |  搜索推荐-实时-备（22）  |     零售-搜索与推荐平台部-搜推数据部-搜索业务数据部李哲      |      0级      |          是、否           |          是（已完成）2020-10-26          | 搜索词大屏–写入：5MB/s;查询QPS：2搜索AB实验写入:80万条/s；查询QPS：5 | CPU使用率：30%内存使用率：30%磁盘使用率：30% |       是        |         有          | 应用层实现 |                    需要                    |
| Doris独占 | ZYX_DR_Pub_04  |                          |                                                              |               |                           |                                          |                                                              |                                              |                 |                     |            |                                            |
| Doris独占 | KC0_DR_Pub_08  |  搜索推荐-实时-主（33）  |     零售-搜索与推荐平台部-搜推数据部-搜索业务数据部李哲      |      0级      |          是、否           |          是（已完成）2020-10-20          | 搜索词大屏–写入：5MB/s;查询QPS：2搜索AB实验写入;100万条/s；查询QPS：5 | CPU使用率：10%内存使用率：3%IO利用率：5%     |       是        |         有          | 应用层实现 |                    需要                    |
|           |                |                          |                                                              |               |                           |                                          |                                                              |                                              |                 |                     |            |                                            |
|  CK独占   | HT0_CK_Pub_01  |     黄金眼-流量-离线     |    零售-技术与数据中心-数据产品平台部-黄金眼研发组屠志强     |      0级      |          是、否           | 是10月14日20:00-23:0010月22日20:00-21:00 |                         查询：QPS10                          | 10.198.17.2节点crash                         |       是        | JDOS+EasyOLAP双机房 |            |                   不需要                   |
|  CK独占   | ZYX_CK_Pub_02  |     黄金眼-流量-实时     |     零售-技术与数据中心-数据产品平台部-黄金眼研发组 洪帅     |      0级      |            否             |                 10月12号                 |                                                              |                                              |       是        |        CK+ES        |            | 新业务计划11.5号上线，上线后视情况安排压测 |
|  CK独占   | ZYX_CK_Pub_04  |   商智-品牌版流量-离线   |     零售-技术与数据中心-数据产品平台部-数据研发组吕美玉      |      0级      |          是、否           |        是压测时间10月14日21-23点         |                       QPS 75618 1.5倍                        | CPU使用率：40%内存使用率：18%磁盘使用率：10% |       是        |    有有限制双流     |            |        需要帮忙一起关注集群健康状态        |
|  CK独占   | ZYX_CK_Pub_08  |  商智-商家版自定义-离线  |     零售-技术与数据中心-数据产品平台部-数据研发组吕美玉      |      0级      |          是、否           |                 否不压测                 |                              --                              | --                                           |       是        |         是          |            |                                            |
|  CK独占   |  LF_CK_Pub_18  |   商智-品牌版交易-离线   |     零售-技术与数据中心-数据产品平台部-数据研发组吕美玉      |      0级      |          否、否           |    是压测时间10月19 17点 -10月20 17点    |                 双十一预估QPS 61压测QPS 157                  | CPU：40%内存：10%磁盘：10%                   |       是        |         有          |            |                                            |
|  CK独占   | ZYX_CK_Pub_07  | 黄金眼-供应链全景图-离线 | 零售-生态业务中心-智能供应链Y业务管理部-供应链研发部-计划管理研发组覃逢春 |     非0级     |          是，否           |                  否，否                  |                                                              |                                              |       否        |         无          |            |                   不需要                   |
|           |                |                          |                                                              |               |                           |                                          |                                                              |                                              |                 |                     |            |                                            |
|  CK独占   | ZYX_CK_Pub_061 |                          | 零售-技术与数据中心-数据共享平台部-系统研发部王书兴建超、周辉 |     非0级     |          是、否           |         否10月23号15：00~16：00          |                 双十一预估QPS 30压测QPS 100                  | CPU：20%内存：30%磁盘：20%                   |       否        |         无          |            |                    需要                    |
|  CK独占   | ZYX_CK_Pub_062 |                          | 零售-技术与数据中心-数据共享平台部-系统研发部王书兴建超、周辉 |     非0级     |          是、否           |         否10月26号19：30~19：50          |                  双十一预估QPS 10压测QPS 30                  | CPU：14%内存：13%磁盘：50%                   |       否        |         无          |            |                    需要                    |
|  CK独占   | ZYX_CK_Pub_063 |                          | 零售-技术与数据中心-数据共享平台部-系统研发部王书兴建超、周辉 |     非0级     |          是、否           |                不需要压测                |                          不需要压测                          | 不需要压测                                   |       否        |         无          |            |                    需要                    |
|  CK独占   | KC0_CK_Pub_16  |                          |                                                              |               |                           |                                          |                                                              |                                              |                 |                     |            |                                            |
|           |                |                          |                                                              |               |                           |                                          |                                                              |                                              |                 |                     |            |                                            |
|  CK独占   | LF0_CK_Pub_17  |        售后全链路        |                   袁建军、尚育锋建超、周辉                   |     非0级     |          是、否           |             是11.6日17-18点              |     总QPS 700（命中EasyData缓存较多），ck接入QPS 100左右     | cpu:50%内存：15%load：25                     |       否        |         无          |            |                                            |
|  CK独占   |  LF_CK_Pub_19  |    大促营销-专属会场     |                   Easy Data 艾佳建超、周辉                   |      0级      |          否、否           |                否10月19日                |                           QPS 600                            | cpu:30%内存：4%load：50                      |                 |                     |            |                                            |
|  CK独占   | LF0_CK_Pub_17  |          直通车          |                 Easy Data 艾佳，任文治、周辉                 |     非0级     |          是、否           |             是11.6日17-18点              |     总QPS 700（命中EasyData缓存较多），ck接入QPS 90左右      | cpu:50%内存：15%load：25                     |       否        |         无          |            |                                            |
| Doris独占 |    drpub07     |     登月系统-实时主      |             零售-搜索与推荐平台部-搜索数据研发部             |      0级      |          是、否           |           是11.6日21:50-23:00            | 写入：三个topic两个topic qps 300K/s 数据量 1.5亿写入持续时间8min一个topic qps 500K/s 数据量 3亿写入持续时间8min查询：qps 10以下 |                                              |       是        |         有          | 应用层实现 |                    需要                    |
| Doris独占 | ZYX_DR_Pub_11  |        客服主集群        |                                                              |               |                           |           是11.5日 18:30-20:11           |                                                              | cpu：50%内存：10%IO利用率：<1%               |                 |                     |            |                                            |







## 共享集群压测记录



Doris：HT0_DR_Pub_01、KC0_DR_Pub_02



Clickhouse：HT0_CK_Pub_10、ZYX_CK_Pub_11、LF0_CK_Pub_12







| OLAP 服务 |                  集群                   |             业务             |                         部门和接口人                         | 业务级别0/非0 | 是否已上线是否可降级是/否 | 是否已压测是/否压测时间 |               压测峰值写入：xx Byte/s查询：QPS               | 压测资源情况CPU/内存/磁盘                                    | 是否需双流是/否 |     双流方案有/无     | quota/每10s查询数量 | quota/最大并行查询数 | 切换演练 |         需要OLAP团队协助          |
| :-------: | :-------------------------------------: | :--------------------------: | :----------------------------------------------------------: | :-----------: | :-----------------------: | :---------------------: | :----------------------------------------------------------: | :----------------------------------------------------------- | :-------------: | :-------------------: | :------------------ | :------------------- | :------- | :-------------------------------: |
| OLAP 服务 |                  集群                   |             业务             |                         部门和接口人                         | 业务级别0/非0 | 是否已上线是否可降级是/否 | 是否已压测是/否压测时间 |               压测峰值写入：xx Byte/s查询：QPS               | 压测资源情况CPU/内存/磁盘                                    | 是否需双流是/否 |     双流方案有/无     | quota/每10s查询数量 | quota/最大并行查询数 | 切换演练 |         需要OLAP团队协助          |
| Doris共享 |              KC0_DR_Pub_02              |             领航             |    物流-技术发展部-数据产品部-经营数据产品组张舜，刘笑言     |     非0级     |          是，否           |      是2020年10.20      |                                                              | CPU使用率:30%内存使用率：15%磁盘使用率：10%                  |       是        |          无           |                     |                      |          | 目前使用备库，独立 集群还在流程中 |
| Doris共享 |              KC0_DR_Pub_02              | 采购场景审核计算退供归档查询 | 京东集团-京东零售-生态业务中心-智能供应链Y业务管理部-供应链研发部-计划管理研发组郝晓明 何贞喜 |     非0级     |          是，否           |           否            |                       查询QPS：60-260                        |                                                              |       否        |          无           |                     |                      |          |                                   |
|           |                                         |                              |                                                              |               |                           |                         |                                                              |                                                              |                 |                       |                     |                      |          |                                   |
|  CK共享   |              HT0_CK_Pub_10              |       通天塔-实时(备)        | 京东集团-京东零售-技术与数据中心-数据基础平台部-数据模型研发部邹子靖 |     非0级     |          否、是           |           是            |                          查询：250                           | CPU:30%Mem: 3.5%Disk: 10%                                    |       是        |          有           |                     |                      |          |        评估现有写入并发度         |
|  CK共享   |              LF0_CK_Pub_12              |       通天塔-实时(主)        | 京东集团-京东零售-技术与数据中心-数据基础平台部-数据模型研发部邹子靖 |     非0级     |          否、是           |           是            |                          查询：250                           | CPU: 8%Mem: 9%DIsk: 0.7%                                     |       是        |          有           |                     |                      |          |        评估现有写入并发度         |
|  CK共享   |              HT0_CK_Pub_10              |        中国黄金-实时         | 京东集团-京东零售-技术与数据中心-数据基础平台部-数据模型研发部吴智博 |     非0级     |          是、否           |      是2020.10.22       |                  QPS：30写入：715087byte/s                   | CPU:30%Mem: 3.5%Disk: 10%                                    |       否        |          否           |                     |                      |          |                                   |
|  CK共享   |              LF0_CK_Pub_12              |     黄金眼7Fresh交易实时     | 京东集团-京东零售-技术与数据中心-数据产品平台部-垂直业务研发组李蓓libei10、于健yujian96 |      0级      |          是、否           |           是            |                   QPS：35写入：43000byte/s                   | CPU:20%Mem: 44%Disk: 12%                                     |       是        |          有           |                     |                      |          |         备：HT0_CK_Pub_10         |
|  CK共享   |              HT0_CK_Pub_10              |      入仓计算器商智融合      | 京东集团-京东零售-生态业务中心-智能供应链Y业务管理部-供应链研发部-计划管理研发组孟晨 |     非0级     |          是、否           |           是            |                          查询：300                           | CPU:30%Mem: 3.5%Disk: 10%                                    |       否        |          否           |                     |                      |          |                                   |
|  CK共享   |              HT0_CK_Pub_10              |     达尔文-渠道价格历史      | 京东集团-京东零售-技术与数据中心-交易研发部-智能交易研发组安亚飞 |     非0级     |          是、否           |      否不参与压测       |                                                              |                                                              |       是        |          有           |                     |                      |          |              不需要               |
|  CK共享   |              ZYX_CK_Pub_11              |         商提-京算盘          |   零售-商业提升事业部-广告数据部-数据应用组赵伟zhaowei171    |     非0级     |          是，否           |      否不参与压测       |                                                              |                                                              |       否        |          有           |                     |                      |          |                                   |
|  CK共享   |              LF0_CK_Pub_12              |        商提-广告大屏         |   零售-商业提升事业部-广告数据部-数据应用组赵伟zhaowei171    |     非0级     |          是、否           |           是            |                    写入：150M查询QPS：100                    | CPU: 8%Mem: 9%DIsk: 0.7%                                     |       否        |          有           |                     |                      |          |                                   |
|           |                                         |                              |                                                              |               |                           |                         |                                                              |                                                              |                 |                       |                     |                      |          |                                   |
|   Doris   |                                         |           京东健康           | 京东集团-京东零售-技术与数据中心-数据基础平台部-数据能力研发部杨鹏飞 |     非0级     |          是，否           |           否            |                            QPS 30                            |                                                              |       否        |          无           |                     |                      |          |              不需要               |
|  CK独占   |              HT0_CK_Pub_10              |         BDP平台运营          | 京东集团-京东零售-技术与数据中心-数据基础平台部-数据服务研发部王紫薇 |     非0级     |          是，否           |       不参与压测        |                            QPS 30                            |                                                              |                 |                       |                     |                      |          |                                   |
|  CK共享   |              LF0_CK_Pub_12              |      京东健康-互医监控       |  京东集团-京东零售-京东健康-产品研发部-互联网医院研发部陈明  |     非0级     |          是，否           |           否            |              写入：30720000 Byte/s查询：100 QPS              | CPU: 8%Mem: 9%DIsk: 0.7%                                     |                 |                       |                     |                      |          |              不确定               |
|  CK共享   | 离线：ZYX_CK_Pub_11 实时：LF0_CK_Pub_12 |           京东火眼           | 京东集团-京东零售-市场营销部-产品研发部-营销研发部张宾、褚阳 |      0级      |      否、否10.21上线      |           否            | 大促预估：15000TpsLF0_CK_Pub_12：压测写入100wTps 查询25 tpsZYX_CK_Pub_11: 查询25 tps | CPU: 8%Mem: 9%DIsk: 0.7%                                     |       否        | 有JDOS+EASYOLAP双机房 |                     |                      |          |                                   |
|  CK共享   |           离线：ZYX_CK_Pub_11           |           天宫业务           | 京东集团-京东零售-商业提升事业部-客户平台部-渠道平台部xiaoshuang7 |     非0级     |          是、否           |     否、不参与压测      |                                                              |                                                              |                 |                       |                     |                      |          |                                   |
|  CK共享   |           离线：ZYX_CK_Pub_11           |        QCR黄金眼看板         | 京东集团-京东零售-生态业务中心-平台生态部-产品及研发部-营销创新研发部-商家数据不lijinglong5 |     非0级     |          是、否           |     否、不参与压测      |                                                              |                                                              |                 |                       |                     |                      |          |                                   |
|  CK共享   |              ZYX_CK_Pub_11              |        采购全流程看板        | 京东集团-京东零售-生态业务中心-智能供应链Y业务管理部-供应链研发部-计划管理研发组郝晓明 何贞喜 |     非0级     |          否、否           |     否、不参与压测      |                                                              |                                                              |       否        |          无           |                     |                      |          |              不需要               |
|  CK共享   |              HT0_CK_Pub_10              |       领券中心频道看板       | 京东集团-京东零售-平台业务中心-平台业务研发部-运营应用研发部-内容基础应用组zhaoyan53 fengyong43 |     非0级     |          是、否           |     否、不参加压测      |                                                              |                                                              |       否        |          否           |                     |                      |          |              不需要               |
|  CK共享   |              HT0_CK_Pub_10              |           飞熊系统           |                     zhaoli257 lichangyou                     |      0级      |          是、否           |   否、预计2020-10-22    |                           QPS：260                           | CPU:30%Mem: 3.5%Disk: 10%                                    |       是        |          有           |                     |                      |          |              不需要               |
|  CK共享   |              HT0_CK_Pub_10              |     飞熊系统（动力部分）     |                     zhaoli257 lichangyou                     |      0级      |                           |                         |                     预估：160请求数/min                      | 业务方通过优化sql加京东动力缓存方式（1分钟之前的数据进缓存）压测压测3倍流量：500请求数/minck qutoa限制： 10 cpu： 保持在3~6% 内存：内存使用率2~3% |                 |                       |                     |                      |          |                                   |
|  CK共享   |           离线：ZYX_CK_Pub_11           |             搜客             | 京东集团-京东零售-商业提升事业部-客户平台部-渠道平台部zhaoli263 |     非0级     |    否、否预计10.25上线    |     否、不参与压测      |                                                              |                                                              |                 |                       |                     |                      |          |                                   |
|  CK共享   |              HT0_CK_Pub_10              |         促销规则系统         | 京东集团-京东零售-生态业务中心-智能供应链Y业务管理部-供应链研发部-定价管理研发组gaozong1 |     非0级     |          是、否           |     否、不参加压测      |                                                              |                                                              |       否        |          否           |                     |                      |          |              不需要               |
|  CK共享   |              ZYX_CK_Pub_11              |      黄金眼-Easy BI使用      | 京东集团-京东零售-技术与数据中心-数据产品平台部-数据研发组lvmeiyu,lichao36 |      0级      |          是、否           |     否、不参加压测      |                                                              |                                                              |                 |          无           |                     |                      |          |                                   |
|  CK共享   |           离线：ZYX_CK_Pub_11           |  智能盘货-涅槃项目-营销选品  | 供应链Y业务管理部-供应链研发部-品类管理研发组 李政lizheng16杜文杰duwenjie4 |     非0级     |          否、否           |     否、不参与压测      |                                                              |                                                              |                 |                       |                     |                      |          |                                   |
|  CK共享   |            实时ZYX_CK_Pub_11            |           售后大屏           |                                                              |               |                           |                         |                            QPS:26                            | CPU:5%men:26%                                                |                 |                       |                     |                      |          |                                   |
| Doris共享 |              HT0_DR_Pub_01              |           菁卡风控           | 京东集团-京东数字科技-风险管理中心-风险管理上海分部-风险研发组张宇zhangyu1458 |      0级      |          是、否           |     否、不参与压测      |                                                              |                                                              |                 |          无           |                     |                      |          |                                   |
| Doris独占 |              HT0_DR_PUB_06              |            EasyBI            |  京东集团-京东零售-技术与数据中心-数据共享平台部-系统研发部  |     非0级     |          是，否           |      是，参与压测       |                                                              | cpu:80%mem:47GB                                              |       否        |          否           |                     |                      |          |               需要                |







6 FINAL,大促

10:00，工具准备

- 检查备用机，周辉
  - HT0_CK_Pub_01，48C256G5.5*8HDD，ip：10.198.16.200, 10.198.16.71, 10.198.16.75, 10.198.16.74
  - HT0_CK_Pub_10，32C/256G/4T*12HDD，ip: 11.11.1.42, 11.11.1.230, 11.11.1.35, 11.11.2.39, 11.11.1.100, 11.11.1.69
  - ZYX_CK_Pub_11，32C/128G/2T*12HDD，ip：10.199.140.148, 10.199.140.117, 10.199.140.122
  - LF0_CK_Pub_12/Pub21/Pub18/Pub19，96C384G9*2TNVME，ip：10.203.24.118, 10.203.24.51, 10.203.46.18, 10.203.46.168
  - LF0_CK_Pub_17，32C/128G/1.2T*12HDD，ip：172.21.62.132
- 终端环境准备集群登陆方式，鲲鹏、MDC等工具准备，提前熟悉监控
  - http://baizegra.jd.com/
  - http://bdpops.jd.com/
  - http://mdc.jd.com/
- 大查询查杀工具，建超，阳仔，高明
- Quota设置工具，建超，阳仔，高明
- 鲲鹏重启脚本，恩杰、阳仔、周辉
- OLAP值班会议ID：345044，10点邀请接口人入会
- 故障处理流程
  - 查杀大查询
  - 设置Quota
  - 重启节点
  - 下线节点
  - 替换节点

11:30，检查监控，确认CPU/内存/磁盘/查询/写入是否正常

- 阳仔Pub10
- 建超Pub11
- 高明Pub12
- 恩杰Pub21/Pub01
- 周辉Pub17/Pub19
- 未上线/不参加大促/降级检查，恩杰
  - Pub02（未上线）
  - Pub08
  - Pub18
- 未上线/不参加大促/降级检查，建超
  - Pub04
  - Pub07（未上线）
  - Pub061（不参加大促）
  - Pub062（不参加大促）
  - Pub063（不参加大促）
  - Pub20（未上线）

00:10，检查监控，确认CPU/内存/磁盘/查询/写入是否正常

- 阳仔Pub10
- 建超Pub11
- 高明Pub12
- 恩杰Pub21
- 恩杰Pub01
- 周辉Pub17
- 周辉Pub19

独占集群1（7个） 23:20 23:50 轮训检查所有集群 9 

- 黄金眼流量 恩杰

  - Pub21，黄金眼离线流量 clickhouse-server 不做改动
    - 10:00，确认UV降级，宋恩杰 图图 2
    - 10:00，服务限流80，宋恩杰 图图  2
    - 11:00，确认导入停止 宋恩杰 图图 6
    - 1:50，恢复服务限流120 宋恩杰 图图 12
  - Pub01，黄金眼离线流量 
    - 11:00 确认写入停止 宋恩杰 图图 6
    - 1:50 恢复服务限流120 宋恩杰 图图 12
  - Pub02，黄金眼实时流量（未上线）
    -  10:40 停写入  宋恩杰 洪帅 5
    -  1:00 恢复导入 宋恩杰 洪帅 11

- 商智（离线）

   恩杰

  - 11:00 Pub04 18 写入完成确认 李刚勇 1
  - 22:30 pub04 18 写入完成再次确认 李刚勇 3
  - 2:00 写入开始 13
  - 11:00 pub08写入完成确认 建超、李刚勇

- 独占集群2（6个） 周辉、建超
  - 共享产品部
    - Pub061
      - 23点降级
      - 02点恢复降级
    - Pub062
      - 23点降级
      - 02点恢复降级
    - Pub063
      - 23点降级
      - 02点恢复降级
  - 数据模型部
    - Pub17，客服集群
      - 确认缓存是否打开，文治
    - Pub19，EasyData集群
      -  确认集群是否正常，艾佳
  - 商提（未上线）
    - Pub20
      - 23点降级
      - 02点恢复降级
- 共享集群（3个）Pub10/Pub11/Pub12
  - 10点
    - 非大促业务降级，Pub10/11阳仔，Pub12高明
    - pub10 crowdmap写入（离线每天13:15写入，可不管），直接降级（包括在上一个）
    - 超时20s （暂不改动，压测平时也符合，已调整为20s）
    - 高风险账户降级、高风险账户查杀、慢查询查杀
    - 飞熊动力部分设置缓存，花璞、鲍震
  - 2点
    - max_execution_time=1800 （暂不改动） 阳仔
    - 中金业务qutoa调整为10 * 15，吴智博
  - Pub10 阳仔
    - 飞熊业务系统，账号：sco_order_onl_detail，花璞、李常友、赵力
    - 飞熊动力大屏，账号：sco_order_onl_detail_dongli，花璞、李常友、赵力
    - 02点恢复状态
  - Pub11 阳仔、建超
    - 黄金眼EasyBI，吕美玉
    - 客服售后大屏，文治
    - 22点非重保业务降级
    - 02点恢复降级
  - Pub12 高明
    - 留意120 q/10s和300q限制
    - 商提-广告大屏，赵伟
    - 京东健康-互医监控，陈明，刘宗节
    - 黄金眼-7Fresh，于健，李蓓
    - 火眼业务，张宾
    - 02点恢复降级

## OLAP（10个）

- 10:00，检查共享集群主备(pub01、pub02)、客服主集群(pub11)配置是否正确，监控是否正常

  - 黄金眼优惠券 - 主
  - 到家优惠券 - 降级
  - 搜索平台（登月计划）- Pub07
  - 客服大屏 - Pub11
    - 确认缓存是否打开
  - 菁卡风控 - 备
  - B2B - 备
  - 通天塔 - 备

- 主集群Pub01：（行泽）：

  操作脚本

  - 11:00 暂停172.18.160.19上的自动恢复任务
  - 11:01 暂停所有写入任务
  - 11:02 恢复黄金眼优惠券、风控、B2B、通天塔写入任务
  - 11:03 限制除黄金眼优惠券、风控、B2B、通天塔外的业务连接数为3
  - 11:08 交叉检查Pub02的导入与连接数限制是否正确
  - 02:00 恢复任务与连接数
  - 02:01 恢复172.18.160.19上的自动恢复任务

- 备集群Pub02：（李阳）：

  操作脚本

  - 11:05 暂停172.18.160.19上的自动恢复任务
  - 11:06 暂停所有写入任务
  - 11:07 恢复搜索、黄金眼优惠券、风控、B2B、通天塔、客服、物流B2B写入任务
  - 11:08 限制除搜索、黄金眼优惠券、风控、B2B、通天塔、客服外的业务连接数为3
  - 11:09 交叉检查Pub01的导入与连接数限制是否正确
  - 00:05 暂停物流B2B写入任务
  - 01:00 恢复物流B2B写入任务
  - 02:00 恢复任务与连接数
  - 02:01 恢复172.18.160.19上的自动恢复任务

- 客服集群Pub11（宋恩杰）：

  操作脚本

  - 11:00 check 李阳 航泽操作 7
  - 11:10 pause and resume 8

- 推荐集群

  - Pub08（主）
    - 检查监控
  - Pub03（备）
    - 检查监控
  - Pub05（离线集群）
    - 检查监控

- 动力集群Pub06 

  - 22:40 确认降级 杨宋 4

- 搜索流量（登月计划）Pub07

  - 检查监控

- 物流独占集群Pub09

  - 检查监控
  - 双流切换

- 商提财务Pub04

  - 检查监控









 

# 注意事项：

业务划分：尽可能做到业务互不干扰 如实时离线集群隔离、不同也业务集群隔离、尽可能多的记录业务属性（如何规避，合理化业务接入流程、预估业务使用资源等等）

ClickHouse 版本确认：可能因集群不断升级，出现clickhouse大版本一致，小版本不一致的情况 （如何规避，合理管理和记录clickhouse 版本和集群使用版本，外围工具如 adminserver、mysql 版本确认 对每次升级记录在册）

重要业务提前双流确认：确定双流集群主备关系，双流集群资源对比，双流集群压测分析等，双流集群很可能因集群资源不一，做合理的调整。

集群降级：合理安排大村期间和压测期间非0级业务降级时间。确认降级队0级业务的影响

明确业务大促真实需求：同一张表可能所提供服务也是分类，一张表整体是0级业务，但是这张表所提供的服务可能部门是非0级的，那么我们的降级就不是表级别的了，而是表从提供的业务级别。需要进一步细化服务和压测范围

信息同步问题：大促期间所有操作需要有acid,从提需求、评价、更改，记录等等

合理安排大促各个操作执行时间：每个操作之间可能对集群是有影响的





# 后续优化方向：



\1. 自动化大促执行流程，避免因人为操作造成的影响



\2. 自动化节点配置更新、节点下线、节点替换、数据清理、集群扩缩容流程



\3. 解决系统痛点



\4. 解决业务痛点