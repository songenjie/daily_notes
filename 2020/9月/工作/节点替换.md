### clickhouse 节点故障问题修复



## 基本条件

1. 所有集群需要有备用机器
2. 集群的所有机器资源初始化 例如 inode 磁盘挂载问题



## 修复/替换流程

1. 故障节点下线
   - 修改集群除故障节点外所有节点配置，去除故障节点 （这里主要原因是用户在用系统表获取所有节点，写入，保障用户写入正常）
   - vip 挂载的故障节点去掉 (这里可以讨论下，是否是必须的，保障 轮训规则，不被轮训规则不会到故障节点)
   - zookeeper 故障节点元数据清理 (这里 1保证副本表同步任务失败一直存在的问题 2 解决新节点上线元数据冲突的问题)
2. 新节点上线
   - 部署程序更新，确定新节点ip替换掉故障节点ip
   - 新节点部署 (鲲鹏)
   - 新节点库表重新创建 （@高明）
3. 集群配置更新
   - 新节点上线 （更新所有节点配置，这里主要指添加新节点的配置）
   - 更新相关文档 （CF相关文档）
   - vip 添加新的节点 （轮训规则）







```
[A01-R26-I140-233-4001862.JD.LOCAL] 2020.09.02 17:01:16.318096 [ 21013 ] {ca752398-f6f0-4b95-a028-09853713786f} <Debug> executeQuery: (from [::ffff:172.18.160.19]:14766)  CREATE TABLE gesc.app_gesc_ck_long_age_fact ( `sku_id` String COMMENT ' sku代码', `sku_name` String COMMENT ' sku名称', `net_type` String COMMENT ' 网络类型', `main_store_id` String COMMENT ' 主仓编号（库房维编号）', `delv_center_id` String COMMENT ' 配送中心编号', `rdc_cdc_id` String COMMENT ' RDC/CDC', `ext_rdc_cdc_id` String COMMENT ' extRDC/ext中心仓', `region_name` String COMMENT ' 区域名称', `supp_code` String COMMENT ' 供应商简码', `item_id` String COMMENT ' 商品编码', `bu_id` String COMMENT ' 事业群代码', `dept_id_1` String COMMENT ' 一级部门代码', `dept_id_2` String COMMENT ' 二级部门代码', `dept_id_3` String COMMENT ' 三级部门代码', `dept_id_4` String COMMENT ' 四级部门代码', `saler_erp` String COMMENT ' 销售员erp', `pur_erp` String COMMENT ' 采购员erp', `pur_control_erp` String COMMENT ' 采控员erp', `item_first_cate_cd` String COMMENT ' 商品一级分类代码', `item_second_cate_cd` String COMMENT ' 商品二级分类代码', `item_third_cate_cd` String COMMENT ' 商品三级分类代码', `book_second_cate_cd` String COMMENT ' 图书虚拟二级品类代码', `brand_code` String COMMENT ' 品牌代码', `cold_type_cd` String COMMENT ' 温层', `band` String COMMENT ' 维度band', `long_age_stock_qtty` Int64 COMMENT ' 长库龄库库存数量', `stock_qtty` Int64 COMMENT ' 库龄口径总库存数量', `long_age_stock_amt` Float64 COMMENT ' 长库龄库存金额', `stock_amt` Float64 COMMENT ' 库龄口径库存金额', `qtty_age_days` Float64 COMMENT ' 每段库龄的库存数*每段库龄', `qtty_from_day8` Int64 COMMENT ' 8天以上库龄库存数量', `qtty_from_day16` Int64 COMMENT ' 16天以上库龄库存数量', `qtty_from_day31` Int64 COMMENT ' 31天以上库龄库存数量', `qtty_from_day46` Int64 COMMENT ' 46天以上库龄库存数量', `qtty_from_day61` Int64 COMMENT ' 61天以上库龄库存数量', `qtty_from_day91` Int64 COMMENT ' 91天以上库龄库存数量', `qtty_from_day121` Int64 COMMENT ' 121天以上库龄库存数量', `qtty_from_day151` Int64 COMMENT ' 151天以上库龄库存数量', `qtty_from_day181` Int64 COMMENT ' 181天以上库龄库存数量', `qtty_from_day211` Int64 COMMENT ' 211天以上库龄库存数量', `qtty_from_day241` Int64 COMMENT ' 241天以上库龄库存数量', `qtty_from_day271` Int64 COMMENT ' 271天以上库龄库存数量', `qtty_from_day301` Int64 COMMENT ' 301天以上库龄库存数量', `qtty_from_day331` Int64 COMMENT ' 331天以上库龄库存数量', `qtty_from_day366` Int64 COMMENT ' 336天以上库龄库存数量', `qtty_from_day731` Int64 COMMENT ' 731天以上库龄库存数量', `qtty_from_day1096` Int64 COMMENT ' 1096天以上库龄库存数量', `qtty_from_day1461` Int64 COMMENT ' 1461天以上库龄库存数量', `qtty_from_day1826` Int64 COMMENT ' 1826天以上库龄库存数量', `qtty_from_day2191` Int64 COMMENT ' 2191天以上库龄库存数量', `qtty_from_day2556` Int64 COMMENT ' 2556天以上库龄库存数量', `amt_from_day8` Float64 COMMENT ' 8天以上库龄库存金额', `amt_from_day16` Float64 COMMENT ' 16天以上库龄库存金额', `amt_from_day31` Float64 COMMENT ' 31天以上库龄库存金额', `amt_from_day46` Float64 COMMENT ' 46天以上库龄库存金额', `amt_from_day61` Float64 COMMENT ' 61天以上库龄库存金额', `amt_from_day91` Float64 COMMENT ' 91天以上库龄库存金额', `amt_from_day121` Float64 COMMENT ' 121天以上库龄库存金额', `amt_from_day151` Float64 COMMENT ' 151天以上库龄库存金额', `amt_from_day181` Float64 COMMENT ' 181天以上库龄库存金额', `amt_from_day211` Float64 COMMENT ' 211天以上库龄库存金额', `amt_from_day241` Float64 COMMENT ' 241天以上库龄库存金额', `amt_from_day271` Float64 COMMENT ' 271天以上库龄库存金额', `amt_from_day301` Float64 COMMENT ' 301天以上库龄库存金额', `amt_from_day331` Float64 COMMENT ' 331天以上库龄库存金额', `amt_from_day366` Float64 COMMENT ' 366天以上库龄库存金额', `amt_from_day731` Float64 COMMENT ' 731天以上库龄库存金额', `amt_from_day1096` Float64 COMMENT ' 1096天以上库龄库存金额', `amt_from_day1461` Float64 COMMENT ' 1461天以上库龄库存金额', `amt_from_day1826` Float64 COMMENT ' 1826天以上库龄库存金额', `amt_from_day2191` Float64 COMMENT ' 2191天以上库龄库存金额', `amt_from_day2556` Float64 COMMENT ' 2556天以上库龄库存金额', `dt` Date COMMENT ' 分区日期' ) ENGINE = ReplicatedMergeTree('/clickhouse/ZYX_CK_Pub_07/jdob_ha/gesc/{shard}/app_gesc_ck_long_age_fact', '{replica}') PARTITION BY dt ORDER BY (bu_id, dept_id_1, dept_id_2, dept_id_3, dept_id_4, net_type, item_first_cate_cd, item_second_cate_cd, item_third_cate_cd, book_second_cate_cd, saler_erp, pur_erp, pur_control_erp, brand_code, supp_code, sku_id) SETTINGS storage_policy = 'jdob_ha', index_granularity = 8192;
[A01-R26-I140-233-4001862.JD.LOCAL] 2020.09.02 17:01:16.318396 [ 21013 ] {ca752398-f6f0-4b95-a028-09853713786f} <Trace> ContextAccess (default): Access granted: CREATE TABLE ON gesc.app_gesc_ck_long_age_fact
[A01-R26-I140-233-4001862.JD.LOCAL] 2020.09.02 17:01:16.321760 [ 21013 ] {ca752398-f6f0-4b95-a028-09853713786f} <Debug> gesc.app_gesc_ck_long_age_fact: Loading data parts
[A01-R26-I140-233-4001862.JD.LOCAL] 2020.09.02 17:01:16.322127 [ 21013 ] {ca752398-f6f0-4b95-a028-09853713786f} <Debug> gesc.app_gesc_ck_long_age_fact: Loaded data parts (0 items)
[A01-R26-I140-233-4001862.JD.LOCAL] 2020.09.02 17:01:16.374193 [ 21013 ] {ca752398-f6f0-4b95-a028-09853713786f} <Debug> gesc.app_gesc_ck_long_age_fact: This table /clickhouse/ZYX_CK_Pub_07/jdob_ha/gesc/031/app_gesc_ck_long_age_fact is already created, will add new replica
[A01-R26-I140-233-4001862.JD.LOCAL] 2020.09.02 17:01:16.375906 [ 21013 ] {ca752398-f6f0-4b95-a028-09853713786f} <Debug> gesc.app_gesc_ck_long_age_fact: Creating replica /clickhouse/ZYX_CK_Pub_07/jdob_ha/gesc/031/app_gesc_ck_long_age_fact/replicas/01
[A01-R26-I140-233-4001862.JD.LOCAL] 2020.09.02 17:01:16.383048 [ 21013 ] {ca752398-f6f0-4b95-a028-09853713786f} <Trace> gesc.app_gesc_ck_long_age_fact: dropIfEmpty
[A01-R26-I140-233-4001862.JD.LOCAL] 2020.09.02 17:01:16.384572 [ 21013 ] {ca752398-f6f0-4b95-a028-09853713786f} <Error> executeQuery: Poco::Exception. Code: 1000, e.code() = 2, e.displayText() = File not found: /data1/jdolap/clickhouse/data/data/gesc/app_gesc_ck_long_age_fact/format_version.txt (version 20.5.2.7 (official build)) (from [::ffff:172.18.160.19]:14766) (in query:  CREATE TABLE gesc.app_gesc_ck_long_age_fact ( `sku_id` String COMMENT ' sku代码', `sku_name` String COMMENT ' sku名称', `net_type` String COMMENT ' 网络类型', `main_store_id` String COMMENT ' 主仓编号（库房维编号）', `delv_center_id` String COMMENT ' 配送中心编号', `rdc_cdc_id` String COMMENT ' RDC/CDC', `ext_rdc_cdc_id` String COMMENT ' extRDC/ext中心仓', `region_name` String COMMENT ' 区域名称', `supp_code` String COMMENT ' 供应商简码', `item_id` String COMMENT ' 商品编码', `bu_id` String COMMENT ' 事业群代码', `dept_id_1` String COMMENT ' 一级部门代码', `dept_id_2` String COMMENT ' 二级部门代码', `dept_id_3` String COMMENT ' 三级部门代码', `dept_id_4` String COMMENT ' 四级部门代码', `saler_erp` String COMMENT ' 销售员erp', `pur_erp` String COMMENT ' 采购员erp', `pur_control_erp` String COMMENT ' 采控员erp', `item_first_cate_cd` String COMMENT ' 商品一级分类代码', `item_second_cate_cd` String COMMENT ' 商品二级分类代码', `item_third_cate_cd` String COMMENT ' 商品三级分类代码', `book_second_cate_cd` String COMMENT ' 图书虚拟二级品类代码', `brand_code` String COMMENT ' 品牌代码', `cold_type_cd` String COMMENT ' 温层', `band` String COMMENT ' 维度band', `long_age_stock_qtty` Int64 COMMENT ' 长库龄库库存数量', `stock_qtty` Int64 COMMENT ' 库龄口径总库存数量', `long_age_stock_amt` Float64 COMMENT ' 长库龄库存金额', `stock_amt` Float64 COMMENT ' 库龄口径库存金额', `qtty_age_days` Float64 COMMENT ' 每段库龄的库存数*每段库龄', `qtty_from_day8` Int64 COMMENT ' 8天以上库龄库存数量', `qtty_from_day16` Int64 COMMENT ' 16天以上库龄库存数量', `qtty_from_day31` Int64 COMMENT ' 31天以上库龄库存数量', `qtty_from_day46` Int64 COMMENT ' 46天以上库龄库存数量', `qtty_from_day61` Int64 COMMENT ' 61天以上库龄库存数量', `qtty_from_day91` Int64 COMMENT ' 91天以上库龄库存数量', `qtty_from_day121` Int64 COMMENT ' 121天以上库龄库存数量', `qtty_from_day151` Int64 COMMENT ' 151天以上库龄库存数量', `qtty_from_day181` Int64 COMMENT ' 181天以上库龄库存数量', `qtty_from_day211` Int64 COMMENT ' 211天以上库龄库存数量', `qtty_from_day241` Int64 COMMENT ' 241天以上库龄库存数量', `qtty_from_day271` Int64 COMMENT ' 271天以上库龄库存数量', `qtty_from_day301` Int64 COMMENT ' 301天以上库龄库存数量', `qtty_from_day331` Int64 COMMENT ' 331天以上库龄库存数量', `qtty_from_day366` Int64 COMMENT ' 336天以上库龄库存数量', `qtty_from_day731` Int64 COMMENT ' 731天以上库龄库存数量', `qtty_from_day1096` Int64 COMMENT ' 1096天以上库龄库存数量', `qtty_from_day1461` Int64 COMMENT ' 1461天以上库龄库存数量', `qtty_from_day1826` Int64 COMMENT ' 1826天以上库龄库存数量', `qtty_from_day2191` Int64 COMMENT ' 2191天以上库龄库存数量', `qtty_from_day2556` Int64 COMMENT ' 2556天以上库龄库存数量', `amt_from_day8` Float64 COMMENT ' 8天以上库龄库存金额', `amt_from_day16` Float64 COMMENT ' 16天以上库龄库存金额', `amt_from_day31` Float64 COMMENT ' 31天以上库龄库存金额', `amt_from_day46` Float64 COMMENT ' 46天以上库龄库存金额', `amt_from_day61` Float64 COMMENT ' 61天以上库龄库存金额', `amt_from_day91` Float64 COMMENT ' 91天以上库龄库存金额', `amt_from_day121` Float64 COMMENT ' 121天以上库龄库存金额', `amt_from_day151` Float64 COMMENT ' 151天以上库龄库存金额', `amt_from_day181` Float64 COMMENT ' 181天以上库龄库存金额', `amt_from_day211` Float64 COMMENT ' 211天以上库龄库存金额', `amt_from_day241` Float64 COMMENT ' 241天以上库龄库存金额', `amt_from_day271` Float64 COMMENT ' 271天以上库龄库存金额', `amt_from_day301` Float64 COMMENT ' 301天以上库龄库存金额', `amt_from_day331` Float64 COMMENT ' 331天以上库龄库存金额', `amt_from_day366` Float64 COMMENT ' 366天以上库龄库存金额', `amt_from_day731` Float64 COMMENT ' 731天以上库龄库存金额', `amt_from_day1096` Float64 COMMENT ' 1096天以上库龄库存金额', `amt_from_day1461` Float64 COMMENT ' 1461天以上库龄库存金额', `amt_from_day1826` Float64 COMMENT ' 1826天以上库龄库存金额', `amt_from_day2191` Float64 COMMENT ' 2191天以上库龄库存金额', `amt_from_day2556` Float64 COMMENT ' 2556天以上库龄库存金额', `dt` Date COMMENT ' 分区日期' ) ENGINE = ReplicatedMergeTree('/clickhouse/ZYX_CK_Pub_07/jdob_ha/gesc/{shard}/app_gesc_ck_long_age_fact', '{replica}') PARTITION BY dt ORDER BY (bu_id, dept_id_1, dept_id_2, dept_id_3, dept_id_4, net_type, item_first_cate_cd, item_second_cate_cd, item_third_cate_cd, book_second_cate_cd, saler_erp, pur_erp, pur_control_erp, brand_code, supp_code, sku_id) SETTINGS storage_policy = 'jdob_ha', index_granularity = 8192;), Stack trace (when copying this message, always include the lines below):

0. Poco::FileNotFoundException::FileNotFoundException(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, int) @ 0x10eda640 in /data0/jdolap/clickhouse/lib/clickhouse
1. Poco::FileImpl::handleLastErrorImpl(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&) @ 0x10ee61ac in /data0/jdolap/clickhouse/lib/clickhouse
2. ? @ 0x10ee661d in /data0/jdolap/clickhouse/lib/clickhouse
3. Poco::File::remove(bool) @ 0x10ee5b90 in /data0/jdolap/clickhouse/lib/clickhouse
4. DB::DiskLocal::remove(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&) @ 0xdab1dc5 in /data0/jdolap/clickhouse/lib/clickhouse
5. DB::MergeTreeData::dropIfEmpty() @ 0xe3e9bdb in /data0/jdolap/clickhouse/lib/clickhouse
6. ? @ 0xe2ce0be in /data0/jdolap/clickhouse/lib/clickhouse
7. ? @ 0xe5e382d in /data0/jdolap/clickhouse/lib/clickhouse
8. std::__1::__function::__func<std::__1::shared_ptr<DB::IStorage> (*)(DB::StorageFactory::Arguments const&), std::__1::allocator<std::__1::shared_ptr<DB::IStorage> (*)(DB::StorageFactory::Arguments const&)>, std::__1::shared_ptr<DB::IStorage> (DB::StorageFactory::Arguments const&)>::operator()(DB::StorageFactory::Arguments const&) @ 0xe5e7a37 in /data0/jdolap/clickhouse/lib/clickhouse
9. DB::StorageFactory::get(DB::ASTCreateQuery const&, std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, DB::Context&, DB::Context&, DB::ColumnsDescription const&, DB::ConstraintsDescription const&, bool) const @ 0xe1e7d2d in /data0/jdolap/clickhouse/lib/clickhouse
10. DB::InterpreterCreateQuery::doCreateTable(DB::ASTCreateQuery&, DB::InterpreterCreateQuery::TableProperties const&) @ 0xdcd7c70 in /data0/jdolap/clickhouse/lib/clickhouse
11. DB::InterpreterCreateQuery::createTable(DB::ASTCreateQuery&) @ 0xdcd816d in /data0/jdolap/clickhouse/lib/clickhouse
12. DB::InterpreterCreateQuery::execute() @ 0xdcd85b1 in /data0/jdolap/clickhouse/lib/clickhouse
13. ? @ 0xe074a59 in /data0/jdolap/clickhouse/lib/clickhouse
14. DB::executeQuery(std::__1::basic_string<char, std::__1::char_traits<char>, std::__1::allocator<char> > const&, DB::Context&, bool, DB::QueryProcessingStage::Enum, bool) @ 0xe07811a in /data0/jdolap/clickhouse/lib/clickhouse
15. DB::TCPHandler::runImpl() @ 0xe698946 in /data0/jdolap/clickhouse/lib/clickhouse
16. DB::TCPHandler::run() @ 0xe699660 in /data0/jdolap/clickhouse/lib/clickhouse
17. Poco::Net::TCPServerConnection::start() @ 0x10deebcb in /data0/jdolap/clickhouse/lib/clickhouse
18. Poco::Net::TCPServerDispatcher::run() @ 0x10def05b in /data0/jdolap/clickhouse/lib/clickhouse
19. Poco::PooledThread::run() @ 0x10f6db86 in /data0/jdolap/clickhouse/lib/clickhouse
20. Poco::ThreadImpl::runnableEntry(void*) @ 0x10f68f80 in /data0/jdolap/clickhouse/lib/clickhouse
21. start_thread @ 0x7dc5 in /usr/lib64/libpthread-2.17.so
22. clone @ 0xf621d in /usr/lib64/libc-2.17.so

```



Zk 删除







```
SELECT replica_num,substr(substitution,length(substitution),1)  FROM system.clusters as A, system.macros as B  where A.is_local=1 and  A.cluster !='system_cluster' and B.macro='replica'  limit 1;
```





```mysql
SELECT 
    database,
    table,
    replica_path,
    substitution AS shard,
    A.replica_name AS replica,
    C.replica_num = CAST(A.replica_name, 'UInt32') AS bool
FROM system.replicas AS A
, system.macros AS B
, system.clusters AS C
WHERE (B.macro = 'shard') AND (C.is_local = '1') AND (C.cluster != 'system_cluster')

[A01-R26-I137-122-J33KMNG.JD.LOCAL] 2020.09.04 15:18:40.728978 [ 10414 ] {c15dbdc9-f14b-423c-a42e-690e21b6fb9c} <Debug> executeQuery: (from [::ffff:172.18.160.19]:54152) SELECT database, table, replica_path, substitution AS shard, A.replica_name AS replica, C.replica_num = CAST(A.replica_name, 'UInt32') AS bool FROM system.replicas AS A , system.macros AS B , system.clusters AS C WHERE (B.macro = 'shard') AND (C.is_local = '1') AND (C.cluster != 'system_cluster');
→ Progress: 0.00 rows, 0.00 B (0.00 rows/s., 0.00 B/s.) 
[A01-R26-I137-122-J33KMNG.JD.LOCAL] 2020.09.04 15:18:40.730600 [ 10414 ] {c15dbdc9-f14b-423c-a42e-690e21b6fb9c} <Trace> ContextAccess (default): Access granted: SELECT(macro, substitution) ON system.macros
[A01-R26-I137-122-J33KMNG.JD.LOCAL] 2020.09.04 15:18:40.730703 [ 10414 ] {c15dbdc9-f14b-423c-a42e-690e21b6fb9c} <Debug> HashJoin: setSampleBlock: macro String String(size = 0), substitution String String(size = 0)
[A01-R26-I137-122-J33KMNG.JD.LOCAL] 2020.09.04 15:18:40.732385 [ 10414 ] {c15dbdc9-f14b-423c-a42e-690e21b6fb9c} <Trace> ContextAccess (default): Access granted: SELECT(macro, substitution) ON system.macros
[A01-R26-I137-122-J33KMNG.JD.LOCAL] 2020.09.04 15:18:40.732471 [ 10414 ] {c15dbdc9-f14b-423c-a42e-690e21b6fb9c} <Debug> HashJoin: setSampleBlock: macro String String(size = 0), substitution String String(size = 0)
[A01-R26-I137-122-J33KMNG.JD.LOCAL] 2020.09.04 15:18:40.734313 [ 10414 ] {c15dbdc9-f14b-423c-a42e-690e21b6fb9c} <Trace> ContextAccess (default): Access granted: SELECT(macro, substitution) ON system.macros
[A01-R26-I137-122-J33KMNG.JD.LOCAL] 2020.09.04 15:18:40.734434 [ 10414 ] {c15dbdc9-f14b-423c-a42e-690e21b6fb9c} <Debug> HashJoin: setSampleBlock: macro String String(size = 0), substitution String String(size = 0)
[A01-R26-I137-122-J33KMNG.JD.LOCAL] 2020.09.04 15:18:40.735700 [ 10414 ] {c15dbdc9-f14b-423c-a42e-690e21b6fb9c} <Trace> ContextAccess (default): Access granted: SELECT(cluster, replica_num, is_local) ON system.clusters
[A01-R26-I137-122-J33KMNG.JD.LOCAL] 2020.09.04 15:18:40.735783 [ 10414 ] {c15dbdc9-f14b-423c-a42e-690e21b6fb9c} <Debug> HashJoin: setSampleBlock: cluster String String(size = 0), is_local UInt8 UInt8(size = 0), replica_num UInt32 UInt32(size = 0)
[A01-R26-I137-122-J33KMNG.JD.LOCAL] 2020.09.04 15:18:40.737310 [ 10414 ] {c15dbdc9-f14b-423c-a42e-690e21b6fb9c} <Trace> ContextAccess (default): Access granted: SELECT(macro, substitution) ON system.macros
[A01-R26-I137-122-J33KMNG.JD.LOCAL] 2020.09.04 15:18:40.737435 [ 10414 ] {c15dbdc9-f14b-423c-a42e-690e21b6fb9c} <Debug> HashJoin: setSampleBlock: macro String String(size = 0), substitution String String(size = 0)
[A01-R26-I137-122-J33KMNG.JD.LOCAL] 2020.09.04 15:18:40.737927 [ 10414 ] {c15dbdc9-f14b-423c-a42e-690e21b6fb9c} <Trace> ContextAccess (default): Access granted: SHOW TABLES ON *.*
[A01-R26-I137-122-J33KMNG.JD.LOCAL] 2020.09.04 15:18:40.738592 [ 10414 ] {c15dbdc9-f14b-423c-a42e-690e21b6fb9c} <Trace> InterpreterSelectQuery: FetchColumns -> Complete
[A01-R26-I137-122-J33KMNG.JD.LOCAL] 2020.09.04 15:18:40.739301 [ 10414 ] {c15dbdc9-f14b-423c-a42e-690e21b6fb9c} <Trace> InterpreterSelectQuery: FetchColumns -> Complete
[A01-R26-I137-122-J33KMNG.JD.LOCAL] 2020.09.04 15:18:40.742880 [ 8027 ] {c15dbdc9-f14b-423c-a42e-690e21b6fb9c} <Trace> CreatingSetsBlockInputStream: Creating join.
[A01-R26-I137-122-J33KMNG.JD.LOCAL] 2020.09.04 15:18:40.743928 [ 8027 ] {c15dbdc9-f14b-423c-a42e-690e21b6fb9c} <Trace> InterpreterSelectQuery: FetchColumns -> Complete
[A01-R26-I137-122-J33KMNG.JD.LOCAL] 2020.09.04 15:18:40.744402 [ 8027 ] {c15dbdc9-f14b-423c-a42e-690e21b6fb9c} <Debug> CreatingSetsBlockInputStream: Created Join with 240 entries from 240 rows in 0.001513654 sec.
[A01-R26-I137-122-J33KMNG.JD.LOCAL] 2020.09.04 15:18:40.744446 [ 8027 ] {c15dbdc9-f14b-423c-a42e-690e21b6fb9c} <Trace> CreatingSetsBlockInputStream: Creating join.
[A01-R26-I137-122-J33KMNG.JD.LOCAL] 2020.09.04 15:18:40.744541 [ 8027 ] {c15dbdc9-f14b-423c-a42e-690e21b6fb9c} <Trace> InterpreterSelectQuery: FetchColumns -> Complete
[A01-R26-I137-122-J33KMNG.JD.LOCAL] 2020.09.04 15:18:40.744797 [ 8027 ] {c15dbdc9-f14b-423c-a42e-690e21b6fb9c} <Debug> CreatingSetsBlockInputStream: Created Join with 2 entries from 2 rows in 0.00034152 sec.
┌─database──┬─table────────────────────────────────┬─replica_path─────────────────────────────────────────────────────────────────────────┬─shard─┬─replica─┬─bool─┐
│ ads       │ ck_bc_flow_browselog                 │ /ckpub04.olap.jd.com/tables/ads/ck_bc_flow_browselog/01/replicas/01                  │ 01    │ 01      │    0 │
│ ads       │ ck_content_browselog_uv_test         │ /ckpub04.olap.jd.com/tables/ads/ck_content_browselog_uv_test/01/replicas/01          │ 01    │ 01      │    0 │
│ ads       │ ck_ge_gmv_app_cmo_datacube_gmv_daily │ /ckpub04.olap.jd.com/tables/ads/ck_ge_gmv_app_cmo_datacube_gmv_daily/01/replicas/01  │ 01    │ 01      │    0 │
│ bc_online │ ck_bc_flow_attention                 │ /ppzhck.jd.local/tables/bc_online/ck_bc_flow_attention/01/replicas/01                │ 01    │ 01      │    0 │
│ bc_online │ ck_bc_flow_browselog                 │ /ppzhck.jd.local/tables/bc_online/ck_bc_flow_browselog/01/replicas/01                │ 01    │ 01      │    0 │
│ bc_online │ ck_bc_flow_cartlog                   │ /ppzhck.jd.local/tables/bc_online/ck_bc_flow_cartlog/01/replicas/01                  │ 01    │ 01      │    0 │
│ bc_online │ ck_bc_flow_deallog                   │ /ppzhck.jd.local/tables/bc_online/ck_bc_flow_deallog/01/replicas/01                  │ 01    │ 01      │    0 │
│ bc_online │ ck_bc_flow_orderlog                  │ /ppzhck.jd.local/tables/bc_online/ck_bc_flow_orderlog/01/replicas/01                 │ 01    │ 01      │    0 │
│ bc_online │ ck_content_base                      │ /ppzhck.jd.local/tables/bc_online/ck_content_base/01/replicas/01                     │ 01    │ 01      │    0 │
│ bc_online │ ck_content_basic_info_pvuv           │ /ppzhck.jd.local/tables/bc_online/ck_content_basic_info_pvuv/01/replicas/01          │ 01    │ 01      │    0 │
│ bc_online │ ck_content_browselog_pv_base         │ /ppzhck.jd.local/tables/bc_online/ck_content_browselog_pv_base/01/replicas/01        │ 01    │ 01      │    0 │
│ bc_online │ ck_content_browselog_uv              │ /ppzhck.jd.local/tables/bc_online/ck_content_browselog_uv/01/replicas/01             │ 01    │ 01      │    0 │
│ bc_online │ ck_content_browselog_uv_base         │ /ppzhck.jd.local/tables/bc_online/ck_content_browselog_uv_base/01/replicas/01        │ 01    │ 01      │    0 │
│ bc_online │ ck_content_cartlog_base              │ /ppzhck.jd.local/tables/bc_online/ck_content_cartlog_base/01/replicas/01             │ 01    │ 01      │    0 │
│ bc_online │ ck_content_deallog_lbase             │ /ppzhck.jd.local/tables/bc_online/ck_content_deallog_lbase/01/replicas/01            │ 01    │ 01      │    0 │
│ bc_online │ ck_content_sku_browselog_base        │ /ppzhck.jd.local/tables/bc_online/ck_content_sku_browselog_base/01/replicas/01       │ 01    │ 01      │    0 │
│ bc_online │ ck_content_type_info                 │ /ppzhck.jd.local/tables/bc_online/ck_content_type_info/01/replicas/01                │ 01    │ 01      │    0 │
│ bc_online │ ck_flow_media_monitor_cart_follow    │ /ppzhck.jd.local/tables/bc_online/ck_flow_media_monitor_cart_follow/01/replicas/01   │ 01    │ 01      │    0 │
│ bc_online │ ck_flow_media_monitor_deal           │ /ppzhck.jd.local/tables/bc_online/ck_flow_media_monitor_deal/01/replicas/01          │ 01    │ 01      │    0 │
│ bc_online │ ck_flow_media_monitor_detail         │ /ppzhck.jd.local/tables/bc_online/ck_flow_media_monitor_detail/01/replicas/01        │ 01    │ 01      │    0 │
│ bc_online │ ck_flow_media_monitor_flow_landpage  │ /ppzhck.jd.local/tables/bc_online/ck_flow_media_monitor_flow_landpage/01/replicas/01 │ 01    │ 01      │    0 │
│ bc_online │ ck_product_ad_cart_payment_ref       │ /ppzhck.jd.local/tables/bc_online/ck_product_ad_cart_payment_ref/01/replicas/01      │ 01    │ 01      │    0 │
│ bc_online │ ck_product_deal_ad_payment_ref       │ /ppzhck.jd.local/tables/bc_online/ck_product_deal_ad_payment_ref/01/replicas/01      │ 01    │ 01      │    0 │
│ bc_online │ ck_product_flow_ad_payment_ref       │ /ppzhck.jd.local/tables/bc_online/ck_product_flow_ad_payment_ref/01/replicas/01      │ 01    │ 01      │    0 │
│ default   │ alerts_local_new                     │ /clickhouse/tables/shard-01/alerts_local_new/replicas/01                             │ 01    │ 01      │    0 │
│ jason     │ table_test_local                     │ /clickhouse/ZYX_CK_Pub_04/jdob_ha/jason/table_test_local/01/replicas/01              │ 01    │ 01      │    0 │
└───────────┴──────────────────────────────────────┴──────────────────────────────────────────────────────────────────────────────────────┴───────┴─────────┴──────┘
↘ Progress: 0.00 rows, 0.00 B (0.00 rows/s., 0.00 B/s.) 
↓ Progress: 269.00 rows, 37.33 KB (10.79 thousand rows/s., 1.50 MB/s.) 
[A01-R26-I137-122-J33KMNG.JD.LOCAL] 2020.09.04 15:18:40.748590 [ 10414 ] {c15dbdc9-f14b-423c-a42e-690e21b6fb9c} <Information> executeQuery: Read 511 rows, 42.95 KiB in 0.019445546 sec., 26278 rows/sec., 2.16 MiB/sec.
[A01-R26-I137-122-J33KMNG.JD.LOCAL] 2020.09.04 15:18:40.748646 [ 10414 ] {c15dbdc9-f14b-423c-a42e-690e21b6fb9c} <Debug> MemoryTracker: Peak memory usage (for query): 87.58 MiB.

26 rows in set. Elapsed: 0.025 sec. 
```





```mysql
SELECT 
    concat('0', toString(shard_num - 1)) AS shard,
    concat('0', toString(replica_num - 1)) AS replica
FROM system.clusters
WHERE (host_name = '10.199.137.134') AND (cluster != 'system_cluster')

[A01-R26-I137-122-J33KMNG.JD.LOCAL] 2020.09.04 16:03:27.228801 [ 17870 ] {bbaa60b3-403a-4db6-87ef-bbc1569fd564} <Debug> executeQuery: (from [::ffff:172.18.160.19]:1486) SELECT concat('0', toString(shard_num - 1)) as shard , concat('0', toString(replica_num - 1)) as replica FROM system.clusters WHERE (host_name = '10.199.137.134') AND (cluster != 'system_cluster');
← Progress: 0.00 rows, 0.00 B (0.00 rows/s., 0.00 B/s.) 
[A01-R26-I137-122-J33KMNG.JD.LOCAL] 2020.09.04 16:03:27.230020 [ 17870 ] {bbaa60b3-403a-4db6-87ef-bbc1569fd564} <Trace> ContextAccess (default): Access granted: SELECT(cluster, shard_num, replica_num, host_name) ON system.clusters
[A01-R26-I137-122-J33KMNG.JD.LOCAL] 2020.09.04 16:03:27.230822 [ 17870 ] {bbaa60b3-403a-4db6-87ef-bbc1569fd564} <Trace> InterpreterSelectQuery: FetchColumns -> Complete
┌─shard─┬─replica─┐
│ 00    │ 02      │
│ 01    │ 03      │
└───────┴─────────┘
↖ Progress: 0.00 rows, 0.00 B (0.00 rows/s., 0.00 B/s.) 
↑ Progress: 240.00 rows, 27.81 KB (31.19 thousand rows/s., 3.61 MB/s.) 
[A01-R26-I137-122-J33KMNG.JD.LOCAL] 2020.09.04 16:03:27.231918 [ 17870 ] {bbaa60b3-403a-4db6-87ef-bbc1569fd564} <Information> executeQuery: Read 240 rows, 27.16 KiB in 0.003007379 sec., 79803 rows/sec., 8.82 MiB/sec.
[A01-R26-I137-122-J33KMNG.JD.LOCAL] 2020.09.04 16:03:27.231964 [ 17870 ] {bbaa60b3-403a-4db6-87ef-bbc1569fd564} <Debug> MemoryTracker: Peak memory usage (for query): 0.00 B.

2 rows in set. Elapsed: 0.008 sec. 



1 IpOfCanUsed
2 IpOfBeReplaced
3 IpOfAdd

1. Connect ck by IpOfCanUsed

2. GetAllReplicatedTableMetadata
SELECT 
    replica_path,
    substitution AS shard,
    A.replica_name AS replica,
    C.replica_num = CAST(A.replica_name, 'UInt32') AS BReduce
FROM system.replicas AS A
, system.macros AS B
, system.clusters AS C
WHERE (B.macro = 'shard') AND (C.is_local = '1') AND (C.cluster != 'system_cluster');

3. Convert shard and replica to macros 

string.replace(replica_path,shard,{shard})
string.replace(replica_path,replica,{replace})

4. Get Replacated shard an Replica 
SELECT 
    concat('0', toString(shard_num - BReduce)) AS shard,
    concat('0', toString(replica_num - BReduce)) AS replica
FROM system.clusters
WHERE (host_name = 'ReplicatedIp') AND (cluster != 'system_cluster');

5. Get All Replicated Ip of Zk Path by shard and Replica 

string.replace(replica_path,{shard},shard)
string.replace(replica_path,{replica},repica)

6. Delete All




1. GetAllZkPath 



SELECT toUInt32(substitution) = replica_num AS BReduce
FROM system.macros
, system.clusters
WHERE (cluster != 'system_cluster') AND (is_local = '1') AND (macro = 'replica');



SELECT 
    concat('0', toString(shard_num - 0)) AS shard,
    concat('0', toString(replica_num - 0)) AS replica
FROM system.clusters
WHERE (host_name = '10.199.137.123') AND (cluster != 'system_cluster');
```









