#### 列式存储

1. 可以更好地进行数据要缩 相同的类型的数据房子啊一起，对压缩更加友好
2. 能够最小化数据扫描的范围



### 数据压缩过程

bin. 文件解析 有多个压缩数据块组成，一个压缩数据块的组成如下：

头信息固定使用9位字节表示，具体由一个Uint8(1字节)整形和2个UInt32(4字节)整型组成，分别代表使用的压缩算法类型，要缩后的数据大小和压缩前的数据大小 0x821200065535.  这里后面头文件式8个字节（压缩后）

| 压缩方法 CompressionMethod_                 | 数据压缩后字节大小 CompressedSize_ | 数据压缩前数据大小 UncompressedSize |
| ------------------------------------------- | ---------------------------------- | ----------------------------------- |
| Type: UInt8 ,Size: 1Byte                    | Type :UInt32,Size 4Byte            | Type :UInt32,Size 4Byte             |
| 82                                          | 12000                              | 65535                               |
| LZ4:0x82 ZSTD:0x90 Multiple:0x91 Delta:0x92 |                                    |                                     |

执行以下命令：

clickhouse compress --stata < /chbase/ data/default/hits_v1/201403_1_34_3/JavaEnable.bin



- 信息如下

65535 12000

65535 14161

65535 4936

65535 7506



- 数据块大小有 上下线设置 64k~1M 

min_compress_block_size(65535 默认 16k) ~ max_compress_block_size(1048576 1M) ,最终压缩的大小，和一个间隔(index_granularity) 内实际大小有关



- 每一批 默认每次取 8192行数据，一批数据未压缩大小设置为size,写入过程为

1. 单个批次数据 size<64KB，如果单个批次数据小于64KB,则继续获取下一批数据，直至累积到>64Kb,直接生成下一个压缩数据块
2. 单个批次64Kb<size<=1MB,直接生成下一个压缩数据块
3. size>1MB,首先会按照1MB截断并生成下一个压缩数据块，剩余数据，依照上述规则执行

![数据压缩过程](/source/clickhouse_概况_数据压缩.jpg)



- 形成要缩数据块的目的

1. 虽然能有效减少数据大小，降低存储空间，并加速数据传输效率，单数据的压缩和解压动作，基本也会带来额外的性能损耗。所以需要控制被压缩数据的大小，以求在性能损耗和压缩效率之间寻求一种平衡
2. 在具体读取某一列数据.bin文件的时候，首先需要将压缩数据加载到内存并解压，这样才能进行后续的数据处理，通过压缩数据块，可以不读区整个.bin文件的情况下，将读取粒度降低到压缩数据块级别，进一步缩小数据读取的范围

![数据存储](/source/clickhouse_概况_数据存储.jpg)





解压缩数据块大小 65535 一共8个8192 16k->2k

[0,8192] [8192,16384]....[57344,65535] 



| .mrk           | .mrk                                                         | .mrk              |            | .binhead   | .binhead   |
| -------------- | ------------------------------------------------------------ | ----------------- | ---------- | ---------- | ---------- |
| 未压缩文件编号 | 压缩块偏移量                                                 | 未/解压缩块偏移量 | 压缩块编号 | 压缩块大小 | 未压缩大小 |
| 0              | 0                                                            | 0                 | 0          |            |            |
| 1              | 0                                                            | 8192              | 0          |            |            |
| 2              | 0                                                            | 16384             | 0          |            |            |
| 3              | 0                                                            | 24576             | 0          |            |            |
| 4              | 0                                                            | 32768             | 0          |            |            |
| 5              | 0                                                            | 40960             | 0          |            |            |
| 6              | 0                                                            | 49152             | 0          |            |            |
| 7              | 0                                                            | 57344             | 0          | 12000      | 65535      |
| 8              | 12016                                                        | 65536/0           | 1          | 14661      | 65535      |
| 9              | 12016=8(前压缩块头)+12000(前压缩块大小)+8(当前压缩块的头大小) | 8192              | 1          |            |            |
|                | 12016                                                        | ...               | 1          |            |            |
|                | ...                                                          |                   |            |            |            |
|                | 1402429                                                      |                   |            |            |            |



